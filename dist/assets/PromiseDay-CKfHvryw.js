import{j as t,k as e,C as n,l as i,p as o,T as s,f as a,a as r,h,m as u,g as d,q as p}from"./index-DI5LSjs4.js";import{B as c}from"./BaseExperience-CpvtY6rA.js";class l extends c{constructor(t,e,n){super(t,e,n),this.points=[],this.line=null,this.isDrawing=!1,this.knotDetected=!1}getInstruction(){return"Draw your promise... tie the knot"}getCompletionMessage(){return"A promise made with love<br>cannot be undone."}async init(){this.createThread(),this.createTargetKnot(),this.setupInteraction(),await super.init(),this.unsubscribeUpdate=this.sceneManager.onUpdate(this.update.bind(this))}createThread(){const s=new t({uniforms:{uTime:{value:0},uColor1:{value:new e(n.champagneGold)},uColor2:{value:new e(n.roseRed)}},vertexShader:"\n        attribute float aLineDistance;\n        varying float vLineDistance;\n        uniform float uTime;\n        \n        void main() {\n          vLineDistance = aLineDistance;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        uniform float uTime;\n        uniform vec3 uColor1;\n        uniform vec3 uColor2;\n        varying float vLineDistance;\n        \n        void main() {\n          float pulse = sin(vLineDistance * 10.0 - uTime * 3.0) * 0.5 + 0.5;\n          vec3 color = mix(uColor1, uColor2, pulse);\n          gl_FragColor = vec4(color, 0.9);\n        }\n      ",transparent:!0});this.lineMaterial=s;const a=new i;this.line=new o(a,s),this.group.add(this.line)}createTargetKnot(){const t=new s(.8,.05,16,32),e=new a({color:n.champagneGold,transparent:!0,opacity:.2});this.knotTarget=new r(t,e),this.knotTarget.position.set(0,0,0),this.knotTarget.rotation.x=Math.PI/2,this.group.add(this.knotTarget)}setupInteraction(){this.boundMouseMove=this.onPointerMove.bind(this),this.boundMouseDown=this.onPointerDown.bind(this),this.boundMouseUp=this.onPointerUp.bind(this),window.addEventListener("mousemove",this.boundMouseMove),window.addEventListener("mousedown",this.boundMouseDown),window.addEventListener("mouseup",this.boundMouseUp),window.addEventListener("touchmove",this.boundMouseMove,{passive:!1}),window.addEventListener("touchstart",this.boundMouseDown,{passive:!1}),window.addEventListener("touchend",this.boundMouseUp,{passive:!1})}onPointerDown(t){"interactive"===this.phase&&("touchstart"===t.type&&t.preventDefault(),this.isDrawing=!0,this.points=[])}onPointerMove(t){if(!this.isDrawing)return;"touchmove"===t.type&&t.preventDefault();const e=t.clientX||t.touches&&t.touches[0]&&t.touches[0].clientX,n=t.clientY||t.touches&&t.touches[0]&&t.touches[0].clientY;if(void 0===e||void 0===n)return;const i=e/window.innerWidth*2-1,o=-n/window.innerHeight*2+1,s=new h(4*i,3*o,0);(0===this.points.length||s.distanceTo(this.points[this.points.length-1])>.1)&&(this.points.push(s),this.updateLine(),this.points.length>20&&this.checkForKnot())}onPointerUp(t){t&&"touchend"===t.type&&t.preventDefault(),this.isDrawing=!1}updateLine(){if(this.points.length<2)return;const t=new Float32Array(3*this.points.length),e=new Float32Array(this.points.length);let n=0;this.points.forEach((i,o)=>{t[3*o]=i.x,t[3*o+1]=i.y,t[3*o+2]=i.z,o>0&&(n+=i.distanceTo(this.points[o-1])),e[o]=n});const o=new i;o.setAttribute("position",new u(t,3)),o.setAttribute("aLineDistance",new u(e,1)),this.line.geometry.dispose(),this.line.geometry=o}checkForKnot(){const t=this.points[this.points.length-1],e=this.points.slice(0,-10).filter(e=>t.distanceTo(e)<.5);if(e.length>0&&!this.knotDetected){this.points.length-this.points.indexOf(e[0])>15&&(this.knotDetected=!0,this.onKnotComplete())}}async onKnotComplete(){d.to(this.knotTarget.scale,{x:.5,y:.5,z:.5,duration:1,ease:"power2.in"}),d.to(this.knotTarget.material,{opacity:1,duration:1});const t=new p(n.champagneGold,0,5);t.position.copy(this.knotTarget.position),this.group.add(t),d.to(t,{intensity:2,duration:1.5,ease:"power2.out",onComplete:()=>this.complete()})}update(t,e){this.isActive&&(this.lineMaterial.uniforms.uTime.value=e,this.knotTarget.rotation.z+=.3*t)}dispose(){this.unsubscribeUpdate&&this.unsubscribeUpdate(),window.removeEventListener("mousemove",this.boundMouseMove),window.removeEventListener("mousedown",this.boundMouseDown),window.removeEventListener("mouseup",this.boundMouseUp),window.removeEventListener("touchmove",this.boundMouseMove),window.removeEventListener("touchstart",this.boundMouseDown),window.removeEventListener("touchend",this.boundMouseUp),super.dispose()}}export{l as default};
