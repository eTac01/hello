import{e as c,a as u,B as h,s as l,T as p,r as m,h as w,l as f,d,o as g}from"./three-BDTjZVi7.js";import{g as a}from"./gsap-C8pce-KX.js";import{B as v}from"./BaseExperience-BpReppXp.js";import{C as r}from"./index-m0RpZGsX.js";class T extends v{constructor(t,e,o){super(t,e,o),this.points=[],this.line=null,this.isDrawing=!1,this.knotDetected=!1}getInstruction(){return"Draw your promise... tie the knot"}getCompletionMessage(){return"A promise made with love<br>cannot be undone."}async init(){this.createThread(),this.createTargetKnot(),this.setupInteraction(),await super.init(),this.unsubscribeUpdate=this.sceneManager.onUpdate(this.update.bind(this))}createThread(){const t=new c({uniforms:{uTime:{value:0},uColor1:{value:new u(r.champagneGold)},uColor2:{value:new u(r.roseRed)}},vertexShader:`
        attribute float aLineDistance;
        varying float vLineDistance;
        uniform float uTime;
        
        void main() {
          vLineDistance = aLineDistance;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,fragmentShader:`
        uniform float uTime;
        uniform vec3 uColor1;
        uniform vec3 uColor2;
        varying float vLineDistance;
        
        void main() {
          float pulse = sin(vLineDistance * 10.0 - uTime * 3.0) * 0.5 + 0.5;
          vec3 color = mix(uColor1, uColor2, pulse);
          gl_FragColor = vec4(color, 0.9);
        }
      `,transparent:!0});this.lineMaterial=t;const e=new h;this.line=new l(e,t),this.group.add(this.line)}createTargetKnot(){const t=new p(.8,.05,16,32),e=new m({color:r.champagneGold,transparent:!0,opacity:.2});this.knotTarget=new w(t,e),this.knotTarget.position.set(0,0,0),this.knotTarget.rotation.x=Math.PI/2,this.group.add(this.knotTarget)}setupInteraction(){this.boundMouseMove=this.onPointerMove.bind(this),this.boundMouseDown=this.onPointerDown.bind(this),this.boundMouseUp=this.onPointerUp.bind(this),window.addEventListener("mousemove",this.boundMouseMove),window.addEventListener("mousedown",this.boundMouseDown),window.addEventListener("mouseup",this.boundMouseUp),window.addEventListener("touchmove",this.boundMouseMove,{passive:!1}),window.addEventListener("touchstart",this.boundMouseDown,{passive:!1}),window.addEventListener("touchend",this.boundMouseUp,{passive:!1})}onPointerDown(t){this.phase==="interactive"&&(t.type==="touchstart"&&t.preventDefault(),this.isDrawing=!0,this.points=[])}onPointerMove(t){if(!this.isDrawing)return;t.type==="touchmove"&&t.preventDefault();const e=t.clientX||t.touches&&t.touches[0]&&t.touches[0].clientX,o=t.clientY||t.touches&&t.touches[0]&&t.touches[0].clientY;if(e===void 0||o===void 0)return;const s=e/window.innerWidth*2-1,n=-(o/window.innerHeight)*2+1,i=new f(s*4,n*3,0);(this.points.length===0||i.distanceTo(this.points[this.points.length-1])>.1)&&(this.points.push(i),this.updateLine(),this.points.length>20&&this.checkForKnot())}onPointerUp(t){t&&t.type==="touchend"&&t.preventDefault(),this.isDrawing=!1}updateLine(){if(this.points.length<2)return;const t=new Float32Array(this.points.length*3),e=new Float32Array(this.points.length);let o=0;this.points.forEach((n,i)=>{t[i*3]=n.x,t[i*3+1]=n.y,t[i*3+2]=n.z,i>0&&(o+=n.distanceTo(this.points[i-1])),e[i]=o});const s=new h;s.setAttribute("position",new d(t,3)),s.setAttribute("aLineDistance",new d(e,1)),this.line.geometry.dispose(),this.line.geometry=s}checkForKnot(){const t=this.points[this.points.length-1],e=this.points.slice(0,-10).filter(o=>t.distanceTo(o)<.5);e.length>0&&!this.knotDetected&&this.points.length-this.points.indexOf(e[0])>15&&(this.knotDetected=!0,this.onKnotComplete())}async onKnotComplete(){a.to(this.knotTarget.scale,{x:.5,y:.5,z:.5,duration:1,ease:"power2.in"}),a.to(this.knotTarget.material,{opacity:1,duration:1});const t=new g(r.champagneGold,0,5);t.position.copy(this.knotTarget.position),this.group.add(t),a.to(t,{intensity:2,duration:1.5,ease:"power2.out",onComplete:()=>this.complete()})}update(t,e){this.isActive&&(this.lineMaterial.uniforms.uTime.value=e,this.knotTarget.rotation.z+=t*.3)}dispose(){this.unsubscribeUpdate&&this.unsubscribeUpdate(),window.removeEventListener("mousemove",this.boundMouseMove),window.removeEventListener("mousedown",this.boundMouseDown),window.removeEventListener("mouseup",this.boundMouseUp),window.removeEventListener("touchmove",this.boundMouseMove),window.removeEventListener("touchstart",this.boundMouseDown),window.removeEventListener("touchend",this.boundMouseUp),super.dispose()}}export{T as default};
